---
query:
  model: true
  sql: |
    select 
        decidim_participatory_processes.id as decidim_participatory_processes_id,
        decidim_participatory_processes.slug as decidim_participatory_processes_slug,
        (case when (decidim_scopes.name->>'fr' = '' is not false) then 'unscoped' else decidim_scopes.name->>'fr' end) as decidim_scope_name,
        (case when (decidim_categories.name->>'fr' = '' is not false) then 'uncategorized' else decidim_categories.name->>'fr' end)  as category,
        regexp_replace(decidim_proposals_proposals.title->>'fr', E'<[^>]+>', '', 'gi') as proposal_title,
        regexp_replace(decidim_proposals_proposals.body->>'fr', E'<[^>]+>', '', 'gi') as proposal_body,
        decidim_areas.name->>'fr' as area_name,
        decidim_area_types.name->>'fr' as area_type_name,
        decidim_proposals_proposals.*
    from decidim_proposals_proposals
        join decidim_components on decidim_components.id = decidim_component_id
        join decidim_participatory_processes on decidim_participatory_processes.id = decidim_components.participatory_space_id
        left join decidim_moderations on decidim_reportable_id = decidim_proposals_proposals.id
        left join decidim_scopes on decidim_scopes.id = decidim_proposals_proposals.decidim_scope_id
        left join decidim_categorizations on decidim_categorizations.categorizable_id = decidim_proposals_proposals.id
        left join decidim_categories on decidim_categories.id = decidim_categorizations.decidim_category_id
        left join decidim_areas on decidim_areas.decidim_organization_id = decidim_participatory_processes.decidim_organization_id
        left join decidim_area_types on decidim_areas.area_type_id = decidim_area_types.id
    where hidden_at is null
        and array_position(array[decidim_proposals_proposals.published_at,decidim_components.published_at, decidim_participatory_processes.published_at], null) is null
  info:
    filterables:
      integer:
        attr: decidim_organization_id
        required: true
      date:
        attr: created_at
        required: false
      integer:
        attr: decidim_participatory_processes.slug
        required: false
    viz_settings:
      scalar:
        - total
      line:
        - day
        - week
        - month
