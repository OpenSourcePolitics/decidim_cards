---
resource: participations
query:
  model: true
  sql: |
    with participations_proposals as (
            select decidim_users.id,
                decidim_proposals_proposals.decidim_component_id,
                'Decidim::Proposals::Proposal' as "participation_type",
                decidim_proposals_proposals.id::text as "participation_id", 
                decidim_proposals_proposals.created_at as participation_date
            from {{#proposals}} as decidim_proposals_proposals
                join decidim_coauthorships on decidim_coauthorships.coauthorable_id = decidim_proposals_proposals.id
                join decidim_users on decidim_users.id = decidim_coauthorships.decidim_author_id
            where coauthorable_type = 'Decidim::Proposals::Proposal'
    ), participations_endorsements as (
            select decidim_users.id,
                decidim_endorsements.decidim_component_id,
                'Decidim::Endorsements::Endorsement' as "participation_type",
                decidim_endorsements.id::text as "participation_id", 
                decidim_endorsements.created_at as participation_date
            from {{#endorsements}} as decidim_endorsements
                join decidim_users on decidim_users.id = decidim_endorsements.decidim_author_id
    ), participations_comments as (
            select decidim_users.id,
                decidim_component_id,
                'Decidim::Comments::Comment' as "participation_type",
                decidim_comments_comments.id::text as "participation_id",
                decidim_comments_comments.created_at as contribution_date
            from {{#comments}} decidim_comments_comments
                join decidim_users on decidim_users.id = decidim_comments_comments.decidim_author_id
    ), participations_proposal_votes as (
            select decidim_users.id,
                decidim_proposals_proposals.decidim_component_id,
                'Decidim::Proposals::ProposalVote' as "participation_type",
                decidim_proposals_proposal_votes.id::text as "participation_id",
                decidim_proposals_proposal_votes.created_at as participation_date
            from decidim_proposals_proposal_votes
                join decidim_users on decidim_users.id = decidim_author_id
                join {{#proposals_votes}} as decidim_proposals_proposals on decidim_proposals_proposal_votes.decidim_proposal_id = decidim_proposals_proposals.id 
    ), participations_answers as (
            select distinct
                decidim_user_id,
                decidim_component_id,
                'Decidim::Forms::Answer' as "participation_type",
              decidim_forms_answers.session_token as "participation_id",
              decidim_forms_answers.created_at::date as participation_date
            from {{#forms_answers}} as decidim_forms_answers
    ), participations_debates as (
            select decidim_author_id as decidim_user_id,
                decidim_component_id,
                'Decidim::Debates::Debate' as "participation_type",
                id::text as participation_id,
                created_at as participation_date
            from {{#3462}} decidim_debates_debates
    ), participations_budgets_projects_votes as (
            select 
                decidim_user_id,
                decidim_component_id,
                'Decidim::Budgets::Project::Vote' as participation_type,
                id::text as participation_id,
                created_at as participation_date
            from {{#projects_votes}} decidim_bugdets_projects_votes
    ), participations_meetings_registrations as (
            select 
                decidim_user_id,
                decidim_component_id,
                'Decidim::Meetings::Registration' as participation_type,
                decidim_meetings_meetings.id::text as participation_id,
                decidim_meetings_registrations.created_at as participation_date
            from {{#meetings}} decidim_meetings_meetings
                join decidim_meetings_registrations on decidim_meetings_registrations.decidim_meeting_id = decidim_meetings_meetings.id
    ), participations as (
        select * from participations_proposals union all
        select * from participations_endorsements union all
        select * from participations_comments union all
        select * from participations_proposal_votes union all
        select * from participations_answers union all
        select * from participations_debates union all
        select * from participations_budgets_projects_votes union all
        select * from participations_meetings_registrations
    )
    select 
        distinct participations.id as "user_id",
        substr(participation_id,1,10)::bigint as participation_id,
        decidim_component_id,
        participation_type,
        participation_date
    from participations
  info:
    meta:
      depends_on: 
      - proposals
      - endorsements
      - forms_answers
      - debates
      - projects_votes
      - meetings 
      - comments
      - blogs_posts
      - proposals_votes
